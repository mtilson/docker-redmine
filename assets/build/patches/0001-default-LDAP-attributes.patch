From b386020709a851663b1da296ab9aa3566e64a36b Mon Sep 17 00:00:00 2001
From: mtilson <m@tilson.biz>
Date: Fri, 15 Jul 2022 09:36:15 -0500
Subject: [PATCH] default LDAP attributes

---
 app/models/auth_source_ldap.rb | 31 +++++++++++++++++++++++++------
 1 file changed, 25 insertions(+), 6 deletions(-)

diff --git a/app/models/auth_source_ldap.rb b/app/models/auth_source_ldap.rb
index 5c87686..9e2cf01 100644
--- a/app/models/auth_source_ldap.rb
+++ b/app/models/auth_source_ldap.rb
@@ -99,7 +99,7 @@ class AuthSourceLdap < AuthSource
     ldap_con = initialize_ldap_con(self.account, self.account_password)
     ldap_con.search(:base => self.base_dn,
                     :filter => search_filter,
-                    :attributes => ['dn', self.attr_login, self.attr_firstname, self.attr_lastname, self.attr_mail],
+                    :attributes => search_attributes_all,
                     :size => 10) do |entry|
       attrs = get_user_attributes_from_ldap_entry(entry)
       attrs[:login] = AuthSourceLdap.get_attr(entry, self.attr_login)
@@ -193,11 +193,26 @@ class AuthSourceLdap < AuthSource
   end
 
   def get_user_attributes_from_ldap_entry(entry)
+    mail = AuthSourceLdap.get_attr(entry, self.attr_mail)
+    if mail.nil? || mail.empty?
+      mail = AuthSourceLdap.get_attr(entry, 'userPrincipalName') + ".by"
+    end
+
+    firstname = AuthSourceLdap.get_attr(entry, self.attr_firstname)
+    if firstname.nil? || firstname.empty?
+      firstname = AuthSourceLdap.get_attr(entry, 'displayName').split(' ')[0]
+    end
+
+    lastname = AuthSourceLdap.get_attr(entry, self.attr_lastname)
+    if lastname.nil? || lastname.empty?
+      lastname = AuthSourceLdap.get_attr(entry, 'displayName').split(' ')[1]
+    end
+
     {
       :dn => entry.dn,
-      :firstname => AuthSourceLdap.get_attr(entry, self.attr_firstname),
-      :lastname => AuthSourceLdap.get_attr(entry, self.attr_lastname),
-      :mail => AuthSourceLdap.get_attr(entry, self.attr_mail),
+      :firstname => firstname,
+      :lastname => lastname,
+      :mail => mail,
       :auth_source_id => self.id
     }
   end
@@ -206,12 +221,16 @@ class AuthSourceLdap < AuthSource
   # include the user attributes if on-the-fly registration is enabled
   def search_attributes
     if onthefly_register?
-      ['dn', self.attr_firstname, self.attr_lastname, self.attr_mail]
+      search_attributes_all
     else
       ['dn']
     end
   end
 
+  def search_attributes_all
+    ['dn', self.attr_login, self.attr_firstname, self.attr_lastname, self.attr_mail, 'userPrincipalName', 'displayName']
+  end
+
   # Check if a DN (user record) authenticates with the password
   def authenticate_dn(dn, password)
     if dn.present? && password.present?
@@ -231,7 +250,7 @@ class AuthSourceLdap < AuthSource
     search_filter = base_filter & Net::LDAP::Filter.eq(self.attr_login, login)
     ldap_con.search( :base => self.base_dn,
                      :filter => search_filter,
-                     :attributes=> search_attributes) do |entry|
+                     :attributes => search_attributes) do |entry|
       if onthefly_register?
         attrs = get_user_attributes_from_ldap_entry(entry)
       else
-- 
2.30.2

